"use strict";var config={role:localStorage.userRole,userId:JSON.parse(localStorage.userInfo).list[0].USER_ID,api_showReportInfo:"/report/showReportInfo",api_showReportInfoDetail:"/report/showReportInfoDetail",api_saveEvaluate:"/report/saveEvaluate",api_deleteSaleReport:"/report/deleteSaleReport",api_reportTj:"/report/reportTj",api_saveDpEvaluate:"/report/saveDpEvaluate.do"};require(["module_dialog_workreport_edit"],function(t){window.app=new Vue({el:"#app",data:{role:config.role,userId:config.userId,tabStatus:1,c:{},d:{},commit:"",reply:"",r:[],readId:"",user:"",type:0,timeStart:"",isDo:"",loading:{loadingStatus:!1,loadingShow:!0},commentReply:"",commentReplyBoxId:"",statistics_type:0,statistics_list:[{data:[]}],statistics_time:"",statistics_now:""},created:function(){var t=this;document.getElementById("app").classList.remove("hide");$(".workreport-list");"销售精英"!=this.role&&"电访销售"!=this.role||(this.tabStatus=2),t.getReportList(),$(".workreport-list")[0].addEventListener("scroll",function(){if(this.scrollTop+this.clientHeight>=this.scrollHeight-50){if(t.loading.loadingStatus)return;t.getReportList()}})},watch:{type:function(t){this.detailReset()},isDo:function(){this.detailReset()},user:function(){this.detailReset()},statistics_type:function(){this.getStatistics(0,this.statistics_type)},commentReplyBoxId:function(){this.commentReply=""}},mounted:function(){var s=this;$(document).on("click",function(t){var e=$(t.target).closest(".comment-reply").length,i=$(t.target).closest(".btn-reply").length;e||i||(s.commentReplyBoxId="")}),$("#salerId").select2({placeholder:"请选择",language:"zh-CN",allowClear:!0,ajax:{url:"/user/getUserInfo",dataType:"json",type:"post",delay:250,data:function(t){return{page:t.page||1,ROLE_ID:"b729e9334ad64c15a4e47d88b8c2638f,30b1487221464d369ca4c2462ccca920",data:{q:t.term||""}}},processResults:function(t,e){return e.page=e.page||1,$.each(t,function(){this.id=this.USER_ID,this.text=this.NAME}),{results:t,pagination:{more:10==t.length}}},cache:!0},minimumInputLength:0}).on("change",function(){s.user=this.value})},methods:{detailReset:function(){this.loading.loadingShow=!0,$("#report_detail").addClass("hide"),this.timeStart="",this.getReportList(),this.readId=""},tab:function(t){var e=this;this.tabStatus=t||1,$("#salerId").val(null).trigger("change"),this.type=0,this.isDo="",Vue.nextTick(function(){e.getReportList(e.tabStatus)}),4==t&&this.getStatistics(0,0)},getReportList:function(t){var e=this;e.loading.loadingStatus=!0,t?(e.tabStatus=t,e.timeStart=""):e.timeStart&&this.r&&this.r.length&&(e.timeStart=0==this.type?this.r[this.r.length-1].time.split("~")[0]:this.r[this.r.length-1].time),$.post(config.api_showReportInfo,{type:e.type,tab:e.tabStatus,timeStart:e.timeStart,isDo:e.isDo,userId:e.user}).done(function(t){e.loading.loadingStatus=!1,e.r&&e.r.length<10&&(e.loading.loadingShow=!1),e.timeStart?e.r=e.r.concat(t.result):(e.r=t.result,e.r.length&&(e.timeStart=0==e.type?e.r[e.r.length-1].time.split("~")[0]:e.r[e.r.length-1].time)),$(".fa-circle-o-notch.fa-spin").is(":visible")&&e.getReportList()})},getReportDetail:function(t){this.readId=t;var e=this;$("#report_detail").addClass("hide"),$.post(config.api_showReportInfoDetail,{id:t}).done(function(t){$("#report_detail").removeClass("hide"),e.d=t.result})},reportAdd:function(){this.$refs.edit.init()},reportEdit:function(t){this.$refs.edit.init(t)},reportDel:function(t){layer.confirm("确认删除此工作报告?",function(){$.post(config.api_deleteSaleReport,{id:t}).done(function(t){"00"==t.error?location.reload():layer.msg(t.msg)})})},submitCommit:function(e){var i=this;this.commit?$.post(config.api_saveEvaluate,{saleReportId:e,Content:i.commit}).done(function(t){i.getReportDetail(e),i.commit="",i.d.isDo||i.userId!=i.d.readMan||$.each(i.r,function(){$.each(this.reportInfo,function(){this.id==e&&(this.isDo=1)})})}):layer.msg("请填写内容后提交")},submitReply:function(t,e){var i=this;i.commentReply?$.post(config.api_saveDpEvaluate,{reportUserId:i.d.userId,dpUserId:e,saleReportId:i.readId,Content:i.commentReply}).done(function(t){i.getReportDetail(i.readId),i.commentReply="",i.commentReplyBoxId=""}):layer.msg("请填写内容后提交")},getStatistics:function(t,e){var i=this;if(0==i.statistics_type){var s=(new Date).getMonth()+1;s=s<10?"0"+s.toString():s,i.statistics_now=(new Date).getFullYear()+"-"+s.toString();var o=i.statistics_time+"-15";if(o=new Date(o).getTime(),0==t)i.statistics_time=i.statistics_now;else if(1==t){o+=2592e6;var a=new Date(o).getMonth()+1;a=a<10?"0"+a.toString():a,i.statistics_time=new Date(o).getFullYear()+"-"+a.toString()}else if(-1==t){o-=2592e6;var r=new Date(o).getMonth()+1;r=r<10?"0"+r.toString():r,i.statistics_time=new Date(o).getFullYear()+"-"+r.toString()}}else i.statistics_now=(new Date).getFullYear(),0==t?i.statistics_time=i.statistics_now:1==t?i.statistics_time=Number(i.statistics_time)+1:-1==t&&(i.statistics_time=Number(i.statistics_time)-1);$.post(config.api_reportTj,{flag:i.statistics_type,time:i.statistics_time}).done(function(t){i.statistics_list=t.result})},loading:function(t){"close"==t?layer.close(this.loadingSwitch):this.loadingSwitch=layer.load(3)},showReportView:function(t){layer.open({type:2,title:"查看报告",area:["100%","100%"],content:"/static/page/workreport/workreport_view.html?id="+t})}}})}),window.parentFnc=function(t){layer.closeAll(),window.app.getCaseRecord(window.app.type)};